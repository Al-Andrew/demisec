#include <log.h>
#include <args.h>

#include <stdio.h>
#include <stdlib.h>
#include <crypto.h>

#include <tcp.h>
#include <errno.h>
#include <netdb.h>
#include <netinet/in.h>
#include <unistd.h>
#include <sys/types.h>
#include <gcrypt.h>

const char* self_pk = "(private-key (rsa (n #00C534FB9FF6E7728A1BB068F8B8B6AC7D7351225DF149076E4B13A23765C7B73B3DA0AA3880D8A2978FF3050BB91DABF5B1CF536D31F9D00A08F800CD85856AFFB388F04883DD2536EC0140572D6D41C2A8626094620559BA10BE0B964B1C887817255FD46C86F7BE860F11CD981D218F8140E864D2AB4C739B17ABAC2D9E89EEBAD35294ED9EC7374274D3AD38D77E9BD21B013CF921BB625633171C8B2FDE258A4468252AF2DF099FE667309104029705D929491AE1A2C2CBA440B70ED549B2991F58B61E45733C59091748FC719725C1D2593986C06E5B489A440FAEC683BC7C77B165B600E1B073C6C43B34B5D541A7825CD79C2861D79CD5E047BAE4415F#)(e #010001#)(d #0519F67065935DD3D372357A49A7A01556B3009A96DAA170944C9BB8FC79B5746387112033BA66EA58CA469523B81AC758F9835A4DC7FD3E65365529A68C9454AD064680F9B8477580EC14B2ACA028EAAA2F1BF9D001FCC2381B5272BEDAAC1A69D988FDC118F4B65F02C0C92568362D5F809857BE036464E686D99008AB6891FD668A382E0DD3C9ADA9C4717765FF6205ACD01C4C9924A702A5FB8F7E55E8487D4A3ECA60E604714F806EC94D491BFDBAE58D5BC69380EC3F1F278D4938FD372FB0CEA92DCD9C15AF61C193EFCE4AD49177A755B368652C00ACEB8FC81DF783591FA58F61B64355FD450E4116D7284DA7CFA6D898BA48D752459A8694298771#)(p #00D01BA988BCB47151EB8808E0917F272849A537775CC06ABB23E7C08A7AD6CEED25AD6C9FD33223DE34FD4A02E3AA29D651B21CB14B74786C7C9542D175BCFE6DEA6D5358F7D9992A2DFE51B95C1D96429AE3167FBEAF03D6C3CF6AB5AE1761BA46DF77A150B0BC04FF9926941E20D82203702A2FFA3AD45FDFDDE0FDCC11AE3D#)(q #00F29719E394937B85152BE5308A6EF9864C89736E86B84E1CFBC889CA0D1DC5DFAAF2609938AFEB16B035941BA5899275C5E0BE799E9C40D2EE00FF70E82DC55A4A3AACFAA04FFBCCFD1EF63AF4DAE7638F651F7D11238CAF536D1741E408143845DA76842DB2715597C1F8EFE856809317239D6D355FFA260752E19065CBE3CB#)(u #00E27644B8DDD81B9FE4DAB7AC088F35A82A097666C33D5EFF5D630A88DF89F80704A3B63E56AE3DB73C2D2177F99E4D39C3939F330B5E2C4F41999F0E6FE23E185B5929229B3028DBC412D64768694978B07C0441B3A7BFB3D3E16E2503D770F0E880CD1C29658830CF269171604EC8D5302C2D188D6CC22147902E6A0E7012B5#)))";
const char* self_sk = "(public-key  (rsa (n #00C534FB9FF6E7728A1BB068F8B8B6AC7D7351225DF149076E4B13A23765C7B73B3DA0AA3880D8A2978FF3050BB91DABF5B1CF536D31F9D00A08F800CD85856AFFB388F04883DD2536EC0140572D6D41C2A8626094620559BA10BE0B964B1C887817255FD46C86F7BE860F11CD981D218F8140E864D2AB4C739B17ABAC2D9E89EEBAD35294ED9EC7374274D3AD38D77E9BD21B013CF921BB625633171C8B2FDE258A4468252AF2DF099FE667309104029705D929491AE1A2C2CBA440B70ED549B2991F58B61E45733C59091748FC719725C1D2593986C06E5B489A440FAEC683BC7C77B165B600E1B073C6C43B34B5D541A7825CD79C2861D79CD5E047BAE4415F#)(e #010001#) ))";

const char* oth_sk = "(public-key (rsa (n #00E16F15FF8FD8D493D410D447EABF68AFCD316D7D2B66189C29A63C661152C5A089018C635AE4C4B5DEDA5929740E6AAA495719DC6C0966268C8303951B6D3EBF460FD475EAE3F05D5AA1BA1B66FF4E9ED8A3D909F600864D111A878C45A72C637C053AC241DC68E3E97C363ECF4008418728B2787BC8FFCCF30CA498FCF7DBE07C16AF4E84CA79B0C89C950E2B0E722D4A7115C5823922BFC382544F249F5E411E792090257F712A94B4759EBF53E8557BDF0FBC3BAC4ADE9F23EF39D341534A5AC46EBF5B894CC31196C9CA6F0852D71CA7499E2C9E2B304CA79F9B30C35518C6AEC1B811E3E13D56143B352F1032682C5EE5EE4CDB1E9A308A54255F029A85#)(e #010001#) ))";

int main(int argc, char** argv) {
    fk_set_log_level(FK_LOG_LEVEL_INFO);

    int* port = fk_arg_int("p", "port", "The port where we should connect to the server", 9922);
    char** ip = fk_arg_string("i", "ip", "The server's ipv4 adress", "127.0.0.1");

    fk_parse_args(argc, argv);
    
    fk_tcp_connection_t server;
    if(fk_tcp_connect(&server, *ip, *port) < 0 ){
        return -1;
    }

    fk_crypto_init();

    fk_crypto_tunnel_t tun;
    fk_crypto_tunnel_new(&server, &tun, self_sk, self_pk, oth_sk);

    char prompt[256] = {'\0'};  
    if(login(tun, prompt) != 0) {
        fk_crypto_tunnel_release(&tun);
        exit(1);
    }

    strcat(prompt, "|");
    fk_message_t pre_user = fk_message_empty();
    pre_user.data = "cd /home/";
    pre_user.dlen = 10;
    fk_crypto_aes_message_write(tun, pre_user);
    fk_message_t pre_resp = fk_message_empty();
    fk_crypto_aes_message_read(tun, &pre_resp);
    strncat(prompt, pre_resp.data, pre_resp.dlen);
    strcat(prompt, "> ");

    bool quit = false;
    while(!quit) {
        fk_message_t req = fk_message_empty();
        fk_message_t resp = fk_message_empty();

        printf("\n%s", prompt);

        getline(&req.data, &req.dlen, stdin);
        req.dlen = strlen(req.data);
        req.data[req.dlen - 1] =' \0';
        fk_crypto_aes_message_write(tun, req);
        fk_crypto_aes_message_read(tun, &resp);
        if( resp.code == 1) {
            quit = true;
        } else if( resp.code == 2) {
            strncpy(strchr(prompt, '|') + 1, resp.data, resp.dlen);
            strcat(prompt, "> ");
        } else {
            printf("%.*s", resp.dlen, resp.data);
        }

        fk_message_release(&req);
        fk_message_release(&resp);
    }
    return 0;
}